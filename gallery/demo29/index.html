<!doctype html>
<meta charset="utf-8">
<link rel="stylesheet" href="../../static/style.css">
<title>demo29 — I❤LA</title>
<body>
  <header>
    <link href="../../static/prism.css" rel="stylesheet" />
    <h1> demo29 </h1>
  </header>
  <script src="../../static/prism.js"></script>
  <div class="page">
    
  

  
    <div class="gallery_post">

    <p>This page shows demo29 implementation.</p>


    
     It comes from  <a href="https://pressureless.github.io/resource/Siggraph2019/%203.%20Light%20Science/Optimal%20Multiple%20Importance%20Sampling/Optimal%20Multiple%20Importance%20Sampling.pdf"> Optimal Multiple Importance Sampling </a><br><br>
    
    
    
    Here is the description: <br>
      <img src=../../static/gallery_res/demo29/demo29.png alt="placeholder" width="700" style='object-fit: scale-down;'><br>
    

    
      <br> Here is the LA input: <br>
      <div class="code_block"><pre ><code class="language-cpsp">sum_i α_i + 1/M sum_i sum_j (f(X_i,j)/`p_c`(X_i,j) - (sum_k α_k p_k X_i,j)/`p_c`(X_i,j))

where


α: ℝ^m
p: ℝ^m
X: ℝ^(m×n)
M: ℝ  
f: ℝ -&gt; ℝ 
`p_c`: ℝ -&gt; ℝ </code></pre></div>
    

    
      <br> Here is the Eigen output: <br>
      <div class="code_block"><pre ><code class="language-cpp">/*
sum_i α_i + 1/M sum_i sum_j (f(X_i,j)/`p_c`(X_i,j) - (sum_k α_k p_k X_i,j)/`p_c`(X_i,j))

where


α: ℝ^m
p: ℝ^m
X: ℝ^(m×n)
M: ℝ  
f: ℝ -&gt; ℝ 
`p_c`: ℝ -&gt; ℝ 
*/
#include &lt;Eigen/Core&gt;
#include &lt;Eigen/Dense&gt;
#include &lt;Eigen/Sparse&gt;
#include &lt;iostream&gt;
#include &lt;set&gt;

/**
 * demo29
 *
 * @param α  ℝ^m
 * @param p  ℝ^m
 * @param X  ℝ^(m×n)
 * @param M  ℝ
 * @param f  ℝ -&gt; ℝ
 * @param p_c  ℝ -&gt; ℝ
 * @return ret
 */
double demo29(
    const Eigen::VectorXd &amp; α,
    const Eigen::VectorXd &amp; p,
    const Eigen::MatrixXd &amp; X,
    const double &amp; M,
    const std::function&lt;double(double)&gt; &amp; f,
    const std::function&lt;double(double)&gt; &amp; p_c)
{
    const long m = X.rows();
    const long n = X.cols();
    assert( α.size() == m );
    assert( p.size() == m );
    assert( X.rows() == m );
    assert( X.cols() == n );

    double _sum_0 = 0;
    for(int i=1; i&lt;=α.size(); i++){
        _sum_0 += α(i-1);
    }
    double _sum_1 = 0;
    for(int i=1; i&lt;=X.rows(); i++){
        double _sum_2 = 0;
        for(int j=1; j&lt;=X.cols(); j++){
            double _sum_3 = 0;
            for(int k=1; k&lt;=p.size(); k++){
                _sum_3 += α(k-1) * p(k-1) * X(i-1, j-1);
            }
            _sum_2 += (f(X(i-1, j-1)) / p_c(X(i-1, j-1)) - (_sum_3) / p_c(X(i-1, j-1)));
        }
        _sum_1 += _sum_2;
    }
    double ret = _sum_0 + 1 / M * _sum_1;
    return ret;
}


void generateRandomData(Eigen::VectorXd &amp; α,
    Eigen::VectorXd &amp; p,
    Eigen::MatrixXd &amp; X,
    double &amp; M,
    std::function&lt;double(double)&gt; &amp; f,
    std::function&lt;double(double)&gt; &amp; p_c)
{
    M = rand() % 10;
    const int m = rand()%10;
    const int n = rand()%10;
    α = Eigen::VectorXd::Random(m);
    p = Eigen::VectorXd::Random(m);
    X = Eigen::MatrixXd::Random(m, n);
    f = [](double)-&gt;double{
        return rand() % 10;
    };
    p_c = [](double)-&gt;double{
        return rand() % 10;
    };
}


int main(int argc, char *argv[])
{
    Eigen::VectorXd α;
    Eigen::VectorXd p;
    Eigen::MatrixXd X;
    double M;
    std::function&lt;double(double)&gt; f;
    std::function&lt;double(double)&gt; p_c;
    generateRandomData(α, p, X, M, f, p_c);
    double func_value = demo29(α, p, X, M, f, p_c);
    std::cout&lt;&lt;&#34;func_value:\n&#34;&lt;&lt;func_value&lt;&lt;std::endl;
    return 0;
}</code></pre></div>
    

    
      <br> Here is the Python output: <br>
      <div class="code_block"><pre ><code class="language-python">&#34;&#34;&#34;
sum_i α_i + 1/M sum_i sum_j (f(X_i,j)/`p_c`(X_i,j) - (sum_k α_k p_k X_i,j)/`p_c`(X_i,j))

where


α: ℝ^m
p: ℝ^m
X: ℝ^(m×n)
M: ℝ  
f: ℝ -&gt; ℝ 
`p_c`: ℝ -&gt; ℝ 
&#34;&#34;&#34;
import numpy as np
import scipy
import scipy.linalg
from scipy import sparse
from scipy.integrate import quad
from scipy.optimize import minimize


def demo29(α, p, X, M, f, p_c):
    &#34;&#34;&#34;
    :param :α : ℝ^m
    :param :p : ℝ^m
    :param :X : ℝ^(m×n)
    :param :M : ℝ
    :param :f : ℝ -&gt; ℝ
    :param :p_c : ℝ -&gt; ℝ
    &#34;&#34;&#34;
    α = np.asarray(α, dtype=np.float64)
    p = np.asarray(p, dtype=np.float64)
    X = np.asarray(X, dtype=np.float64)

    m = X.shape[0]
    n = X.shape[1]
    assert α.shape == (m,)
    assert p.shape == (m,)
    assert X.shape == (m, n)
    assert np.ndim(M) == 0

    _sum_0 = 0
    for i in range(1, len(α)+1):
        _sum_0 += α[i-1]
    _sum_1 = 0
    for i in range(1, len(X)+1):
        _sum_2 = 0
        for j in range(1, len(X)+1):
            _sum_3 = 0
            for k in range(1, len(p)+1):
                _sum_3 += α[k-1] * p[k-1] * X[i-1, j-1]
            _sum_2 += (f(X[i-1, j-1]) / p_c(X[i-1, j-1]) - (_sum_3) / p_c(X[i-1, j-1]))
        _sum_1 += _sum_2
    ret = _sum_0 + 1 / M * _sum_1
    return ret


def generateRandomData():
    M = np.random.randn()
    m = np.random.randint(10)
    n = np.random.randint(10)
    α = np.random.randn(m)
    p = np.random.randn(m)
    X = np.random.randn(m, n)
    def f(p0):
        return np.random.randn()
    def p_c(p0):
        return np.random.randn()
    return α, p, X, M, f, p_c


if __name__ == &#39;__main__&#39;:
    α, p, X, M, f, p_c = generateRandomData()
    print(&#34;α:&#34;, α)
    print(&#34;p:&#34;, p)
    print(&#34;X:&#34;, X)
    print(&#34;M:&#34;, M)
    print(&#34;f:&#34;, f)
    print(&#34;p_c:&#34;, p_c)
    func_value = demo29(α, p, X, M, f, p_c)
    print(&#34;func_value: &#34;, func_value)</code></pre></div>
    

    
      <br> Here is the Tex output: <br>
      <div class="code_block"><pre ><code class="language-tex">\documentclass[12pt]{article}
\usepackage{mathdots}
\usepackage[bb=boondox]{mathalfa}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{ctex}
\setmainfont{Linux Libertine O}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\begin{document}
\[
\sum_\textit{i} \textit{α}_{ \textit{i} } + \frac{1}{\textit{M}}\sum_\textit{i} \sum_\textit{j} (\frac{\textit{f}(\textit{X}_{\textit{i}, \textit{j}})}{\textit{p\_c}(\textit{X}_{\textit{i}, \textit{j}})} - \frac{(\sum_\textit{k} \textit{α}_{ \textit{k} }\textit{p}_{ \textit{k} }\textit{X}_{\textit{i}, \textit{j}})}{\textit{p\_c}(\textit{X}_{\textit{i}, \textit{j}})})
\]

where
\begin{itemize}
\item $\textit{α} \in \mathbb{R}^{ \textit{m}}$
\item $\textit{p} \in \mathbb{R}^{ \textit{m}}$
\item $\textit{X} \in \mathbb{R}^{ \textit{m} \times \textit{n} }$
\item $\textit{M} \in \mathbb{{R}}$
\item $\textit{f} \in \mathbb{{R}}\rightarrow \mathbb{{R}}$
\item $\textit{p\_c} \in \mathbb{{R}}\rightarrow \mathbb{{R}}$
\end{itemize}


\end{document}</code></pre></div>
    

    
      <br> Below is the pdf: <br>
      <img src=../../static/gallery_res/demo29/demo29.pdf alt="placeholder" width="700" style='object-fit: scale-down;'><br>
    
    </div>
  


 



  </div>
</body>
